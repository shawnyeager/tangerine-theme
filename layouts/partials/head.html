{{/*
Purpose: Generates HTML <head> element with all meta tags, links, and scripts

Parameters: None (uses page and site context)

Context Expected:
- .IsHome, .IsPage, .Kind - Page type detection
- .Title, .Description, .Type - Page metadata
- .Date, .Lastmod - Article dates
- .Site.Title, .Site.Params.* - Site configuration
- .Params.* - Page frontmatter parameters

Features:
- SEO meta tags (title, description, canonical)
- Open Graph tags for social sharing
- Twitter Card tags (switches between summary_large_image and summary based on content type)
- Parameterized favicon (solid vs outlined based on .Site.Params.favicon_style)
- Dark mode initialization script (prevents FOUC)
- Plausible analytics integration (optional)
- Structured data (JSON-LD) via partials
- Resource fingerprinting and SRI for CSS
- Font preloading for performance

Important Notes:
- Essays should have .Description in frontmatter (used for OG description)
- Dark mode script runs immediately to prevent flash of unstyled content
- Favicon style parameter: "solid" for .com, "outlined" for .notes
- Twitter cards use square images for essays/notes, landscape for other pages
- Robots meta controlled by .Site.Params.noindex
*/}}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark light">
    <title>{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    <meta name="description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta name="author" content="{{ .Site.Params.author.name }}">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">
    <link rel="canonical" href="{{ .Permalink }}">

    <!-- Preload critical resources -->
    <link rel="preload" href="{{ "fonts/inter-variable.woff2" | relURL }}" as="font" type="font/woff2" crossorigin>
    {{- $cssPath := "css/main.css" -}}
    {{- $css := (resources.Get $cssPath) -}}
    {{- if $css -}}
      {{/* Create non-fingerprinted version for XSLT reference */}}
      {{- $cssPlain := $css | resources.Minify -}}
      {{- $cssPlainPermalink := $cssPlain.RelPermalink -}}

      {{/* Create fingerprinted version for site */}}
      {{- $cssFingerprinted := $css | resources.Minify | resources.Fingerprint -}}
      <link rel="preload" href="{{ $cssFingerprinted.RelPermalink }}" as="style" integrity="{{ $cssFingerprinted.Data.Integrity }}">
    {{- else -}}
      <link rel="preload" href="{{ $cssPath | relURL }}" as="style">
    {{- end -}}

    <!-- CSS -->
    {{- if $css -}}
      {{- $cssFingerprinted := $css | resources.Minify | resources.Fingerprint -}}
      <link rel="stylesheet" href="{{ $cssFingerprinted.RelPermalink }}" integrity="{{ $cssFingerprinted.Data.Integrity }}">
    {{- else -}}
      <link rel="stylesheet" href="{{ $cssPath | relURL }}">
    {{- end -}}
    
    <!-- RSS Feed -->
    {{ with .OutputFormats.Get "rss" -}}
    {{ printf `<link rel="%s" type="%s" href="%s" title="%s" />` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
    {{ end -}}

    <!-- Sitemap -->
    <link rel="sitemap" type="application/xml" href="{{ "sitemap.xml" | absURL }}" title="Sitemap">

    <!-- Privacy-friendly analytics by Plausible (optional) -->
    {{ if .Site.Params.plausible_script_id }}
    <link rel="dns-prefetch" href="https://plausible.io">
    <link rel="preconnect" href="https://plausible.io" crossorigin>
    <script async src="https://plausible.io/js/{{ .Site.Params.plausible_script_id }}.js"></script>
    <script>
      window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
      plausible.init()
    </script>
    {{ end }}

    <!-- Track 404 pages in Plausible -->
    {{ if and (eq .Kind "404") .Site.Params.plausible_script_id }}
    <script>document.addEventListener('DOMContentLoaded', function () { plausible('404'); });</script>
    {{ end }}

    <!-- Favicon (parameterized: solid for .com, outlined for .notes) -->
    <!-- SVG favicon for modern browsers (best quality, brand orange color) -->
    {{ if eq .Site.Params.favicon_style "outlined" }}
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='2' y='2' width='28' height='28' fill='none' stroke='%23F84200' stroke-width='4'/%3E%3C/svg%3E">
    {{ else }}
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='2' y='2' width='28' height='28' fill='%23F84200'/%3E%3C/svg%3E">
    {{ end }}
    <!-- File-based favicons for Google and legacy browsers -->
    <link rel="icon" type="image/x-icon" href="{{ "favicon.ico" | relURL }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ "favicon-32x32.png" | relURL }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ "favicon-16x16.png" | relURL }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ "apple-touch-icon.png" | relURL }}">

    <!-- Dark Mode Initialization - Runs immediately to prevent FOUC -->
    <script>
        (function() {
            try {
                const stored = localStorage.getItem('tangerine-theme-preference');
                if (stored) {
                    document.documentElement.setAttribute('data-theme', stored);
                }
            } catch (e) {
                // Fail silently - fall back to system preference via CSS media query
            }
        })();
    </script>

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="{{ if .Title }}{{ .Title }}{{ else }}{{ .Site.Title }}{{ end }}">
    <meta property="og:description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
    <meta property="og:url" content="{{ .Permalink }}">
    {{- $ogImageURL := partial "functions/get-og-image.html" . -}}
    {{ if $ogImageURL }}
    <meta property="og:image" content="{{ $ogImageURL }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    {{ end }}
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="{{ .Site.Title }}">
    {{- if and .IsPage (or (eq .Type "essays") (eq .Type "notes")) -}}
    <!-- Article-specific Open Graph tags -->
    <meta property="article:published_time" content="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
    <meta property="article:modified_time" content="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
    <meta property="article:author" content="{{ .Site.BaseURL }}">
    {{- if .Params.topics -}}
    <meta property="article:section" content="{{ index .Params.topics 0 }}">
    {{- end -}}
    {{- range .Params.tags -}}
    <meta property="article:tag" content="{{ . }}">
    {{- end -}}
    {{- end -}}

    <!-- Twitter Card -->
    {{- $twitterImageURL := "" -}}
    {{- $twitterCardType := "summary_large_image" -}}
    {{- if .Params.image -}}
      {{- $twitterImageURL = .Params.image | absURL -}}
    {{- else if eq .Type "essays" -}}
      {{- $slug := .Params.slug -}}
      {{- $squareOGPath := printf "/images/og-essays/%s-square.png" $slug -}}
      {{- $twitterImageURL = $squareOGPath | absURL -}}
      {{- $twitterCardType = "summary" -}}
    {{- else if eq .Type "notes" -}}
      {{- $slug := .Params.slug -}}
      {{- $squareOGPath := printf "/images/og-notes/%s-square.png" $slug -}}
      {{- $twitterImageURL = $squareOGPath | absURL -}}
      {{- $twitterCardType = "summary" -}}
    {{- else if $ogImageURL -}}
      {{- $twitterImageURL = $ogImageURL -}}
    {{- end -}}
    <meta name="twitter:card" content="{{ $twitterCardType }}">
    <meta name="twitter:title" content="{{ if .Title }}{{ .Title }}{{ else }}{{ .Site.Title }}{{ end }}">
    <meta name="twitter:description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    {{ if $twitterImageURL }}
    <meta name="twitter:image" content="{{ $twitterImageURL }}">
    <meta name="twitter:image:alt" content="{{ if .Title }}{{ .Title }}{{ else }}{{ .Site.Title }}{{ end }}">
    {{ end }}
    {{- if .Site.Params.twitter_handle -}}
    <meta name="twitter:site" content="@{{ .Site.Params.twitter_handle }}">
    <meta name="twitter:creator" content="@{{ .Site.Params.twitter_handle }}">
    {{- end -}}

    <!-- Robots meta tag -->
    <meta name="robots" content="{{ if .Site.Params.noindex }}noindex, nofollow{{ else }}index, follow{{ end }}">

    <!-- Structured Data (JSON-LD) -->
    {{ partial "structured-data.html" . }}
    {{ partial "structured-data-website.html" . }}
    {{ partial "structured-data-collection.html" . }}
    {{ partial "structured-data-breadcrumbs.html" . }}
</head>
